var Torp=function(a,b,c,h,j){var d=world.netrek2world(a,b),d=new Circle(2,{y:d[0],x:d[1],fill:imageLib.getRaceColor(h)});this.x=a;this.y=b;this.team=h;this.dir=c;this.gfx=d;this.includingWorld=j;this.includingWorld.add(this)};Torp.prototype={};IND=0;ROM=1;KLI=2;ORI=4;FED=8;
var imageLib={ships:"SC,DD,CA,BB,AS,SB".split(","),races:["Rom","Kli","Ori","Fed"],raceIds:[ROM,KLI,ORI,FED],images:[],loadAll:function(){for(var a=0;a<this.races.length;++a){this.images[this.raceIds[a]]=[];for(var b=0;b<this.ships.length;++b){var c=new Image;this.images[this.raceIds[a]][b]=c;c.src="/data/img/"+this.races[a]+"/"+this.ships[b]+"0.png"}}},getRaceColor:function(a,b){return a==FED?b?"#330":"#FF0":a==KLI?b?"#030":"#0F0":a==ROM?b?"#300":"#F00":a==ORI?b?"#003":"#00F":"#FFF"}};function BufferPack(){var a,b=!1,c=this;c._DeArray=function(a,b,c){return[a.slice(b,b+c)]};c._EnArray=function(a,b,c,g){for(var e=0;e<c;a[b+e]=g[e]?g[e]:0,e++);};c._DeChar=function(a,b){return String.fromCharCode(a[b])};c._EnChar=function(a,b,c){a[b]=c.charCodeAt(0)};c._DeInt=function(c,j){var d=b?a.len-1:0,g=b?-1:1,e=d+g*a.len,f,k;f=0;for(k=1;d!=e;f+=c[j+d]*k,d+=g,k*=256);a.bSigned&&f&Math.pow(2,8*a.len-1)&&(f-=Math.pow(2,8*a.len));return f};c._EnInt=function(c,j,d){for(var g=b?a.len-1:0,e=b?-1:
1,f=g+e*a.len,d=d<a.min?a.min:d>a.max?a.max:d;g!=f;c[j+g]=d&255,g+=e,d>>=8);};c._DeString=function(a,b,c){for(var g=Array(c),e=0;e<c;g[e]=String.fromCharCode(a[b+e]),e++);return g.join("")};c._EnString=function(a,b,c,g){for(var e,f=0;f<c;a[b+f]=(e=g.charCodeAt(f))?e:0,f++);};c._DeNullString=function(a,b,d,g){a=c._DeString(a,b,d,g);return a.substring(0,a.length-1)};c._De754=function(c,j){var d,g,e,f,k,l,m,n,o;m=a.mLen;e=8*a.len-a.mLen-1;o=(1<<e)-1;n=o>>1;f=b?0:a.len-1;k=b?1:-1;d=c[j+f];f+=k;l=-7;g=
d&(1<<-l)-1;d>>=-l;for(l+=e;0<l;g=256*g+c[j+f],f+=k,l-=8);e=g&(1<<-l)-1;g>>=-l;for(l+=m;0<l;e=256*e+c[j+f],f+=k,l-=8);switch(g){case 0:g=1-n;break;case o:return e?NaN:Infinity*(d?-1:1);default:e+=Math.pow(2,m),g-=n}return(d?-1:1)*e*Math.pow(2,g-m)};c._En754=function(c,j,d){var g,e,f,k,l,m,n;m=a.mLen;n=8*a.len-a.mLen-1;k=(1<<n)-1;f=k>>1;g=0>d?1:0;d=Math.abs(d);if(isNaN(d)||Infinity==d)d=isNaN(d)?1:0,e=k;else{e=Math.floor(Math.log(d)/Math.LN2);if(1>d*(l=Math.pow(2,-e)))e--,l*=2;d=1<=e+f?d+a.rt/l:d+
a.rt*Math.pow(2,1-f);2<=d*l&&(e++,l/=2);e+f>=k?(d=0,e=k):1<=e+f?(d=(d*l-1)*Math.pow(2,m),e+=f):(d=d*Math.pow(2,f-1)*Math.pow(2,m),e=0)}f=b?a.len-1:0;for(k=b?-1:1;8<=m;c[j+f]=d&255,f+=k,d/=256,m-=8);e=e<<m|d;for(n+=m;0<n;c[j+f]=e&255,f+=k,e/=256,n-=8);c[j+f-k]|=128*g};c._sPattern="(\\d+)?([AxcbBhHsSfdiIlL])(\\(([a-zA-Z0-9]+)\\))?";c._lenLut={A:1,x:1,c:1,b:1,B:1,h:2,H:2,s:1,S:1,f:4,d:8,i:4,I:4,l:4,L:4};c._elLut={A:{en:c._EnArray,de:c._DeArray},s:{en:c._EnString,de:c._DeString},S:{en:c._EnString,de:c._DeNullString},
c:{en:c._EnChar,de:c._DeChar},b:{en:c._EnInt,de:c._DeInt,len:1,bSigned:!0,min:-Math.pow(2,7),max:Math.pow(2,7)-1},B:{en:c._EnInt,de:c._DeInt,len:1,bSigned:!1,min:0,max:Math.pow(2,8)-1},h:{en:c._EnInt,de:c._DeInt,len:2,bSigned:!0,min:-Math.pow(2,15),max:Math.pow(2,15)-1},H:{en:c._EnInt,de:c._DeInt,len:2,bSigned:!1,min:0,max:Math.pow(2,16)-1},i:{en:c._EnInt,de:c._DeInt,len:4,bSigned:!0,min:-Math.pow(2,31),max:Math.pow(2,31)-1},I:{en:c._EnInt,de:c._DeInt,len:4,bSigned:!1,min:0,max:Math.pow(2,32)-1},
l:{en:c._EnInt,de:c._DeInt,len:4,bSigned:!0,min:-Math.pow(2,31),max:Math.pow(2,31)-1},L:{en:c._EnInt,de:c._DeInt,len:4,bSigned:!1,min:0,max:Math.pow(2,32)-1},f:{en:c._En754,de:c._De754,len:4,mLen:23,rt:Math.pow(2,-24)-Math.pow(2,-77)},d:{en:c._En754,de:c._De754,len:8,mLen:52,rt:0}};c._UnpackSeries=function(b,c,d,g){for(var e=a.de,f=[],k=0;k<b;f.push(e(d,g+k*c)),k++);return f};c._PackSeries=function(b,c,d,g,e,f){for(var k=a.en,l=0;l<b;k(d,g+l*c,e[f+l]),l++);};c._zip=function(a,b){for(var c={},g=0;g<
a.length;g++)c[a[g]]=b[g];return c};c.unpack=function(c,j,d){b="<"!=c.charAt(0);for(var d=d?d:0,g=RegExp(this._sPattern,"g"),e,f,k,l=[],m=[];e=g.exec(c);){f=void 0==e[1]||""==e[1]?1:parseInt(e[1]);if("S"===e[2]){for(f=0;0!==j[d+f];)f++;f++}k=this._lenLut[e[2]];if(d+f*k>j.length)return;switch(e[2]){case "A":case "s":case "S":m.push(this._elLut[e[2]].de(j,d,f));break;case "c":case "b":case "B":case "h":case "H":case "i":case "I":case "l":case "L":case "f":case "d":a=this._elLut[e[2]],m.push(this._UnpackSeries(f,
k,j,d))}l.push(e[4]);d+=f*k}m=Array.prototype.concat.apply([],m);return-1!==l.indexOf(void 0)?m:this._zip(l,m)};c.packTo=function(c,j,d,g){b="<"!=c.charAt(0);for(var e=RegExp(this._sPattern,"g"),f,k,l,m=0;f=e.exec(c);){k=void 0==f[1]||""==f[1]?1:parseInt(f[1]);"S"===f[2]&&(k=g[m].length+1);l=this._lenLut[f[2]];if(d+k*l>j.length)return!1;switch(f[2]){case "A":case "s":case "S":if(m+1>g.length)return!1;this._elLut[f[2]].en(j,d,k,g[m]);m+=1;break;case "c":case "b":case "B":case "h":case "H":case "i":case "I":case "l":case "L":case "f":case "d":a=
this._elLut[f[2]];if(m+k>g.length)return!1;this._PackSeries(k,l,j,d,g,m);m+=k;break;case "x":for(f=0;f<k;f++)j[d+f]=0}d+=k*l}return j};c.pack=function(a,b){return this.packTo(a,Array(this.calcLength(a,b)),0,b)};c.calcLength=function(a,b){for(var c=RegExp(this._sPattern,"g"),g,e=0,f=0;g=c.exec(a);){var k=(void 0==g[1]||""==g[1]?1:parseInt(g[1]))*this._lenLut[g[2]];"S"===g[2]&&(k=b[f].length+1);e+=k;f++}return e};this.stringToBytes=function(a){for(var b=[],c=0;c<a.length;++c)b[c]=a.charCodeAt(c);return b}}
packer=new BufferPack;NetrekConnection=function(a,b,c){this.host=a||"localhost";this.port=b||8080;this.serverPort=this.serverHost=null;this.conn=io.connect("ws://"+this.host+":"+this.port);this.conn.once("connect",c);this.buffer="";this.reading=!1;this.getServerList=function(a){this.conn.once("serverData",function(b){"function"===typeof a&&a(b)});this.conn.emit("serverDataReq")};this.connectToServer=function(a,b,c){b=b||2592;this.serverHost=a;this.serverPort=b;var g=this;this.conn.once("serverConnected",function(){document.title+=
" - "+g.serverHost;g.sendArray(CP_SOCKET.data(10));this.on("message",function(a){g.buffer+=atob(a);g.readMessages()});this.once("serverClosure",function(){alert("The Netrek server unexpected closed the connection.  You probably timed out.  Anyway, try reloading the page.")});c()});this.conn.emit("joinServer",{host:a,port:b})};this.sendArray=function(a){this.conn.send(btoa(String.fromCharCode.apply(this,a)))};this.readMessages=function(){if(0==this.buffer.length)this.reading=!1;else{this.reading=!0;
var a=this.buffer.charCodeAt(0),b=serverPackets[a];if(void 0===b)console.error("unknown message code "+a),this.buffer=this.buffer.substr(1),this.readMessages();else{var a=packer.calcLength(b.format),c=this.buffer.substr(0,a);c.length==a?(this.buffer=this.buffer.substr(a),b.handler(packer.stringToBytes(c)),this.readMessages()):this.reading=!1}}}};Array.prototype.next=function(){return this.splice(0,1)[0]};net_logging=!1;
serverPackets=[{code:11,format:"!bxxx80s",handler:function(a){(a=packer.unpack(this.format,a))&&(message=a[1]);net_logging&&console.log(message)}},{code:12,format:"!bbbbbbxxIlllhhhh",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),h=b.next(),j=b.next(),d=b.next(),g=b.next(),e=b.next(),f=b.next(),k=b.next(),l=b.next(),m=b.next(),n=b.next(),b=b.next();net_logging&&console.log("SP_YOU pnum=",a,"hostile=",team_decode(c),"swar=",team_decode(h),"armies=",j,"tractor=",
d,"flags=",g.toString(2),"damage=",e,"shield=",f,"fuel=",k,"etemp=",l,"wtemp=",m,"whydead=",n,"whodead=",b);null==world.playerNum&&(world.playerNum=a);hud.showFuelLevel(k/100);hud.showHullLevel(100-e/100);hud.showShieldLevel(f/100)}},{code:24,format:"!bbbx16s16s16s",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),h=b.next(),j=b.next(),b=b.next();net_logging&&console.log("SP_PL_LOGIN pnum=",a,"rank=",c,"name=",h,"monitor=",j,"login=",b)}},{code:22,format:"!bbbb",
handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),b=b.next();net_logging&&console.log("SP_HOSTILE pnum=",a,"war=",team_decode(c),"hostile=",team_decode(b))}},{code:2,format:"!bbbb",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),b=team_decode(b.next());net_logging&&console.log("SP_PLAYER_INFO pnum=",a,"shiptype=",c,"team=",b);var h=imageLib.images[b.length?b[0]:FED][c];void 0==world.ships[a]&&world.addShip(a,new Ship({img:h,
galImg:imageLib.images[1][c],team:b[0]||1,number:a.toString()}))}},{code:3,format:"!bbxxI",handler:function(a){var b=packer.unpack(this.format,a);b.next();a=b.next();b=b.next();net_logging&&console.log("SP_KILLS pnum=",a,"kills=",b)}},{code:20,format:"!bbbx",handler:function(a){var b=packer.unpack(this.format,a);b.next();a=b.next();b=b.next();net_logging&&console.log("SP_PSTATUS pnum=",a,"status=",b)}},{code:4,format:"!bbBbll",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=
b.next(),c=b.next(),h=b.next(),j=b.next(),b=b.next();net_logging&&console.log("SP_PLAYER pnum=",a,"dir=",c,"speed=",h,"x=",j,"y=",b);world.ships[a].setRotation(c);world.ships[a].setPosition(j,b);world.ships[a].speed=h}},{code:18,format:"!bbbxI",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),b=b.next();net_logging&&console.log("SP_FLAGS pnum=",a,"tractor=",c,"flags=",b)}},{code:26,format:"!bbxxll16s",handler:function(a){var b=packer.unpack(this.format,a);
b.next();var a=b.next(),c=b.next(),h=b.next(),b=b.next();net_logging&&console.log("SP_PLANET_LOC pnum=",a,"x=",c,"y=",h,"name=",b);void 0==world.planets[a]&&world.addPlanet(a,new world.Planet(c,h,b,[],world))}},{code:17,format:"!bbxxl96s",handler:function(a){a=packer.unpack(this.format,a);a.next();var b=a.next(),c=a.next();a.next();net_logging&&console.log("SP_LOGIN accept=",b,"flags=",c.toString(2))}},{code:19,format:"!bbxx",handler:function(a){a=packer.unpack(this.format,a);a.next();a=a.next();
net_logging&&console.log("SP_MASK mask=",team_decode(a))}},{code:16,format:"!bbxx",handler:function(a){a=packer.unpack(this.format,a);a.next();a=a.next();net_logging&&console.log("SP_PICKOK state=",a);1==a&&(outfitting.undraw(),world.ships[world.playerNum],world.draw())}},{code:25,format:"!bxxx16s",handler:function(a){a=packer.unpack(this.format,a);a.next();a=a.next();a=packer.unpack("16b",a);net_logging&&console.log("SP_RESERVED data=",a)}},{code:5,format:"!bbbxhxx",handler:function(a){var b=packer.unpack(this.format,
a);b.next();var a=b.next(),c=b.next(),b=b.next();net_logging&&console.log("SP_TORP_INFO war=",team_decode(a)," status=",c," tnum=",b);void 0==world.torps[b]&&1==c&&world.addTorp(b,new Torp(-1E4,-1E4,0,a,world));void 0!=world.torps[b]&&0==c&&world.removeTorp(b)}},{code:6,format:"!bBhll",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),h=b.next(),b=b.next();net_logging&&console.log("SP_TORP dir=",a," tnum=",c," x=",h," y=",b);void 0!=world.torps[c]&&(world.torps[c].dir=
a,world.torps[c].x=h,world.torps[c].y=b)}},{code:8,format:"!bbbxhxx",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),b=b.next();net_logging&&console.log("SP_PLASMA_INFO war=",team_decode(a),"status=",c,"pnum=",b)}},{code:9,format:"!bxhll",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),b=b.next();net_logging&&console.log("SP_PLASMA pnum=",a,"x=",c,"y=",b)}},{code:14,format:"!bbxxIIIIIL",handler:function(a){var b=packer.unpack(this.format,
a);b.next();var a=b.next(),c=b.next(),h=b.next(),j=b.next(),d=b.next(),g=b.next(),b=b.next();net_logging&&console.log("SP_STATUS tourn=",a,"armsbomb=",c,"planets=",h,"kills=",j,"losses=",d,"time=",g,"timepro=",b)}},{code:7,format:"!bbbBlll",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),h=b.next(),j=b.next(),d=b.next(),b=b.next();net_logging&&console.log("SP_PHASER pnum=",a,"status=",c,"dir=",h,"x=",j,"y=",d,"target=",b)}},{code:15,format:"!bbbbhxxl",handler:function(a){var b=
packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),h=b.next(),j=b.next(),b=b.next();net_logging&&console.log("SP_PLANET pnum=",a,"owner=",c,"info=",h,"flags=",j.toString(2),"armies=",b)}},{code:1,format:"!bBBB80s",handler:function(a){var b=packer.unpack(this.format,a);b.next();var a=b.next(),c=b.next(),h=b.next(),b=b.next();net_logging&&console.log("SP_MESSAGE m_flags=",a.toString(2),"m_recpt=",c,"m_from=",h,"mesg=",b)}},{code:23,format:"!bbxx13l",handler:function(a){var b=packer.unpack(this.format,
a);b.next();var a=b.next(),c=b.next(),h=b.next(),j=b.next(),d=b.next(),g=b.next(),e=b.next(),f=b.next(),k=b.next(),l=b.next(),m=b.next(),n=b.next(),o=b.next(),b=b.next();net_logging&&console.log("SP_STATS pnum=",a,"tkills=",c,"tlosses=",h,"kills=",j,"losses=",d,"tticks=",g,"tplanets=",e,"tarmies=",f,"sbkills=",k,"sblosses=",l,"armies=",m,"planets=",n,"maxkills=",o,"sbmaxkills=",b)}},{code:10,format:"!bxxx80s",handler:function(a){a=packer.unpack(this.format,a);a.next();a=a.next();net_logging&&console.log("SP_WARNING message=",
a)}}];CP_SOCKET={code:27,format:"!bbbxI",data:function(a){net_logging&&console.log("CP_SOCKET");return packer.pack(this.format,[this.code,4,a,0])}};CP_LOGIN={code:8,format:"!bbxx16s16s16s",data:function(a,b,c,h){net_logging&&console.log("CP_LOGIN query=",a,"name=",b);return packer.pack(this.format,[this.code,a,b,c,h])}};CP_UPDATES={code:31,format:"!bxxxI",data:function(a){net_logging&&console.log("CP_UPDATES usecs=",a);return packer.pack(this.format,[this.code,a])}};
CP_OUTFIT={code:9,format:"!bbbx",data:function(a,b){net_logging&&console.log("CP_OUTFIT team=",race_decode(a),"ship=",b);return packer.pack(this.format,[this.code,a,b])}};CP_SPEED={code:2,format:"!bbxx",data:function(a){net_logging&&console.log("CP_SPEED speed=",a);return packer.pack(this.format,[this.code,a])}};CP_DIRECTION={code:3,format:"!bBxx",data:function(a){net_logging&&console.log("CP_DIRECTION direction=",a);return packer.pack(this.format,[this.code,a&255])}};
CP_PHASER={code:4,format:"!bBxx",data:function(a){net_logging&&console.log("CP_PHASER direction=",a);return packer.pack(this.format,[this.code,a&255])}};CP_PLASMA={code:5,format:"!bBxx",data:function(a){net_logging&&console.log("CP_PLASMA direction=",a);return packer.pack(this.format,[this.code,a&255])}};CP_TORP={code:6,format:"!bBxx",data:function(a){net_logging&&console.log("CP_TORP direction=",a);return packer.pack(this.format,[this.code,a&255])}};
for(var sp=[],i=0;i<serverPackets.length;++i)sp[serverPackets[i].code]=serverPackets[i];serverPackets=sp;function team_decode(a){var b=[];a&FED&&b.push(FED);a&ROM&&b.push(ROM);a&KLI&&b.push(KLI);a&ORI&&b.push(ORI);return b}function race_decode(a){switch(a){case 0:return"IND";case 1:return"FED";case 2:return"ROM";case 4:return"KLI";case 8:return"ORI"}};var SC=0,DD=1,CA=2,BB=3,AS=4,SB=5;
outfitting={canvasWidth:500,canvasHeight:500,raceButtonDim:96,shipButtonDim:70,oCanvas:null,infoBox:null,raceButtons:[],shipButtons:[],otherElems:[],selectedShip:CA,mask:[],defaultInfoText:"Select a ship, then choose a race to;enter the game.;;;;New players should try a Cruiser first.".split(";"),makeRaceButton:function(a,b,c,h,j,d,g){var e=this,f="Your race sets your team alligience and;your home planet (for refit & respawn).;;Each ship class is identical across all;races, e.g., a Klingon Scout is just;as good as a Federation one.".split(";"),h=
new Rectangle(this.raceButtonDim,this.raceButtonDim,{x:h,y:j,rx:10,ry:10,strokeWidth:2,stroke:d,fill:g});h.append(new TextNode(a,{y:30,x:this.raceButtonDim/2,fill:d,font:"bold 20pt Courier",textAlign:"center"}));h.append(new TextNode(b,{y:this.raceButtonDim-15,x:this.raceButtonDim/2,fill:d,font:"bold 11pt Courier",textAlign:"center"}));h.addEventListener("mouseover",function(){e.showInfoText(f)});h.addEventListener("mouseout",function(){e.showInfoText(e.defaultInfoText)});h.addEventListener("click",
function(){world.player.setImage(imageLib.images[c][e.selectedShip]);world.player.setTeam(c);net.sendArray(CP_OUTFIT.data(c,e.selectedShip))});return h},makeShipButton:function(a,b,c,h,j,d,g){var e=this,c=new Rectangle(this.shipButtonDim,this.shipButtonDim,{x:c,y:h,rx:10,ry:10,strokeWidth:2,stroke:j,fill:d});c.append(new TextNode(a,{y:15,x:this.shipButtonDim/2,fill:j,font:"bold 8pt Courier",textAlign:"center"}));c.addEventListener("mouseover",function(){e.showInfoText(g)});c.addEventListener("mouseout",
function(){e.showInfoText(e.defaultInfoText)});c.addEventListener("click",function(){e.selectShip(b)});return c},init:function(a){this.oCanvas=a;var a=this.canvasWidth-this.raceButtonDim-10,b=this.canvasHeight-this.raceButtonDim-10;this.raceButtons.push(this.makeRaceButton("ROM","Romulans",ROM,10,10,imageLib.getRaceColor(ROM),imageLib.getRaceColor(ROM,!0)));this.raceButtons.push(this.makeRaceButton("KLI","Klingons",KLI,a,10,imageLib.getRaceColor(KLI),imageLib.getRaceColor(KLI,!0)));this.raceButtons.push(this.makeRaceButton("FED",
"Federation",3,10,b,imageLib.getRaceColor(3),imageLib.getRaceColor(FED,!0)));this.raceButtons.push(this.makeRaceButton("ORI","Orions",4,a,b,imageLib.getRaceColor(4),imageLib.getRaceColor(ORI,!0)));var a=(this.canvasWidth-this.shipButtonDim)/2-5,b=this.shipButtonDim+60+5,c=a-this.shipButtonDim-5,h=a+this.shipButtonDim+10;this.shipButtons[SC]=this.makeShipButton("Scout",SC,c,60,"#0FF","#033","Fast and light, the Scout excels at;dodging enemy fire and rushing behind;enemy lines to bomb planets.;;It has weak phasers, but fast torpedos,;making it fit for long-range fighting.".split(";"));
this.shipButtons[DD]=this.makeShipButton("Destroyer",DD,a,60,"#0FF","#033",["The Destroyer is a challenging ship to","command effectively, but is noted for","its superior cloaking abilites.","","Useful for suicide runs on Starbases."]);this.shipButtons[CA]=this.makeShipButton("Cruiser",CA,c,b,"#0FF","#033",["A well-balanced ship, favored widely","by captains of all skill levels.","","Highly recommended for new players."]);this.shipButtons[BB]=this.makeShipButton("Battleship",BB,a,b,"#0FF","#033",
["Slow and powerful, Battleships can take","a beating, but their powerful weapons","use up fuel quickly.","","Excellent for planet defense."]);this.shipButtons[AS]=this.makeShipButton("Assult",AS,h,60,"#0FF","#033","With proper support, the Assult Ship can;capture planets quite swiftly. It holds;more armies than any other ship and it;is an unmatched planet bomber.;;It also withstands damage very well.".split(";"));this.shipButtons[SB]=this.makeShipButton("Starbase",SB,h,b,"#0FF","#033",["Available only to the most experienced",
"players, a Starbase can usually be","destroyed only by a coordinated effort","(called 'ogging')."]);this.shipButtons[SB].opacity=0.3;this.otherElems.push(new Line(h-5,70,h-5,b+this.shipButtonDim-10,{stroke:"#0CC",strokeWidth:2}));this.infoBox=new Rectangle(420,120,{x:a-210+this.shipButtonDim/2,y:b+this.shipButtonDim+20,rx:10,ry:10,strokeWidth:2,stroke:"#5FF",fill:"#033"});this.selectShip(CA)},draw:function(){for(var a=0;a<this.raceButtons.length;++a)this.oCanvas.append(this.raceButtons[a]);for(a=
0;a<this.shipButtons.length;++a)this.oCanvas.append(this.shipButtons[a]);for(a=0;a<this.otherElems.length;++a)this.oCanvas.append(this.otherElems[a]);this.showInfoText(this.defaultInfoText);this.oCanvas.append(this.infoBox)},undraw:function(){this.oCanvas.removeAllChildren()},applyMask:function(){},showInfoText:function(a){this.infoBox.removeAllChildren();for(var b=0;b<a.length;++b)this.infoBox.append(new TextNode(a[b],{y:17*(b+1)+5,x:10,font:"12pt Courier",fill:this.infoBox.stroke}))},selectShip:function(a){if(a!=
SB){var b=this.shipButtons[this.selectedShip];b&&(b.stroke="#0FF",b.strokeWidth=2,b.fill="#033");this.selectedShip=a;a=this.shipButtons[this.selectedShip];a.stroke="#F0F";a.strokeWidth=4;a.fill="#404"}}};var Ship=function(a){void 0==a&&(a={});this.x=a.x||0;this.y=a.y||0;this.number=a.number;this.team=a.team;this.radius=a.radius||12;this.heading=a.heading||0;this.omega=a.omega||0;this.speed=a.speed||0;this.targetHeading=a.targetHeading||null;this.targetSpeed=a.targetSpeed||0;if("object"!=typeof a.gfx){var b=world.netrek2world(a.x,a.y);this.gfx=new Circle(this.radius,{y:b[0]+a.img.height/2,x:b[1]+a.img.width/2,stroke:imageLib.getRaceColor(a.team),strokeWidth:1,fill:"none",radius:12,zIndex:1E7});this.gfx.append(new ImageNode(a.img,
{x:0,y:0,centered:!0,stroke:"none",zIndex:-1}))}else this.gfx=a.gfx;this.gfx.append(new TextNode(this.number,{x:15,y:-3,fill:imageLib.getRaceColor(a.team),font:"bold"}));"object"!=typeof a.galGfx?(b=world.netrek2tac(a.x,a.y),this.galGfx=new Circle(this.radius,{y:b[0],x:b[1],fill:imageLib.getRaceColor(a.team),radius:4,zIndex:1E7})):this.gfx=a.gfx;(this.includingWorld=a.world)&&this.includingWorld.add(this)};
Ship.prototype={setPosition:function(a,b){this.x=a;this.y=b},setRotation:function(a){this.gfx.childNodes[0].rotation=[2*Math.PI*a/255,0,0]},setImage:function(a){this.gfx.childNodes[0].image=a},setTeam:function(a){this.team=a;this.galGfx.fill=imageLib.getRaceColor(a)},setVisible:function(){}};hud={inited:!1,hCanvas:null,shieldMeter:null,shieldText:null,damageMeter:null,damageText:null,fuelMeter:null,fuelText:null,uiGfx:null,init:function(a){this.hCanvas=a;this.uiGfx=new CanvasNode;this.healthCircle=new Circle(29,{x:35,y:465,fill:"#0C0",stroke:"none",rotation:Math.PI/2});this.shieldMeter=new Circle(35,{stroke:"#3AF",fill:"none",strokeWidth:8,startAngle:0,endAngle:Math.PI,rotation:0.8*Math.PI});this.damageMeter=new Circle(15,{stroke:"#A00",fill:"none",strokeWidth:30,startAngle:0,endAngle:0});
this.damageText=new TextNode("100",{fill:"white",rotation:-Math.PI/2,textAlign:"center",font:"bold 12pt courier",x:-7});this.shieldText=new TextNode("100",{fill:"white",rotation:-Math.PI/2,textAlign:"center",font:"bold 12pt courier",x:17});this.healthCircle.append(this.damageMeter);this.healthCircle.append(this.shieldMeter);this.healthCircle.append(this.damageText);this.healthCircle.append(this.shieldText);this.uiGfx.append(this.healthCircle);this.fuelBox=new Rectangle(300,20,{x:100,y:475,stroke:"#D60",
strokeWidth:2});this.fuelMeter=new Rectangle(200,20,{fill:"#F70",stroke:"none"});this.fuelBox.append(new Circle(10,{startAngle:Math.PI/2,endAngle:-Math.PI/2,y:10,x:-1,fill:"#F70"}));this.fuelBox.append(new Circle(10,{startAngle:-Math.PI/2,endAngle:Math.PI/2,y:10,x:300,fill:"#F70",stroke:"none"}));this.fuelText=new TextNode("100",{y:15,x:150,textAlign:"center",fill:"white",font:"bold 12pt courier"});this.fuelBox.append(this.fuelMeter);this.fuelBox.append(this.fuelText);this.uiGfx.append(this.fuelBox);
this.uiGfx.opacity="0.9"},draw:function(){this.hCanvas.append(this.uiGfx)},undraw:function(){this.hCanvas.removeChild(this.uiGfx)},showShieldLevel:function(a){a=Math.max(0,Math.min(100,a));this.shieldMeter.startAngle=(100-a)/100*Math.PI;this.shieldText.text=Math.floor(a).toString()},showHullLevel:function(a){a=Math.max(0,Math.min(100,a));this.damageMeter.endAngle=2*(100-a)/100*Math.PI;this.damageText.text=Math.floor(a).toString()},showFuelLevel:function(a){a=Math.max(0,Math.min(100,a));this.fuelMeter.width=
300*(a/100);this.fuelText.text=Math.floor(a).toString()+"%"}};world={wCanvas:null,gCanvas:null,wGroup:new CanvasNode,gGroup:new CanvasNode,objects:[],ships:[],planets:[],torps:[],stepPeriod:50,stepInterval:null,stepListeners:[],viewX:0,viewY:0,galacticFactor:200,subgalacticFactor:40,playerNum:null,player:null,init:function(a,b){this.wCanvas=a;this.gCanvas=b;this.galacticFactor=1E5/b.width},draw:function(){this.wCanvas.append(this.wGroup);this.gCanvas.append(this.gGroup);var a=this;this.wCanvas.addFrameListener(function(){a.centerView(a.player.x,a.player.y);
for(var b=0;b<a.objects.length;++b){var c=a.objects[b],h=a.netrek2world(c.x,c.y);c.gfx.x=h[0];c.gfx.y=h[1];c.galGfx&&(h=a.netrek2tac(c.x,c.y),c.galGfx.x=h[0],c.galGfx.y=h[1])}});hud.draw();$(this.wCanvas.canvas).bind("contextmenu",function(b){var c=$(this).offset();net.sendArray(CP_DIRECTION.data(a.rad2byte(a.getAngleFromCenter(b.pageX-c.left,b.pageY-c.top))));b.preventDefault()});$(this.wCanvas.canvas).click(function(b){var c=$(this).offset();net.sendArray(CP_TORP.data(a.rad2byte(a.getAngleFromCenter(b.pageX-
c.left,b.pageY-c.top))));b.preventDefault()});$(this.wCanvas.canvas).mousedown(function(b){if(2==b.which){var c=$(this).offset();net.sendArray(CP_PHASER.data(a.rad2byte(a.getAngleFromCenter(b.pageX-c.left,b.pageY-c.top))));b.preventDefault()}});$(document).bind("keyup",function(a){48<=a.which&&57>=a.which&&net.sendArray(CP_SPEED.data(a.which-48))})},undraw:function(){this.wCanvas.removeChild(this.wGroup);this.gCanvas.removeChild(this.gGroup);hud.undraw();$(this.wCanvas.canvas).unbind("click",fireTorpWithLeftClick);
$(this.wCanvas.canvas).unbind("contextmenu",setCourseWithRightClick);$(this.wCanvas.canvas).unbind("mousedown",firePhasersWithMIddleClick);$(this.wCanvas.canvas).unbind("keyup",setSpeedWithNumbers)},add:function(a){this.wGroup.append(a.gfx);a.galGfx&&this.gGroup.append(a.galGfx);this.objects.push(a)},remove:function(a){this.objects.splice(this.objects.indexOf(a,1));a.gfx.removeSelf();a.galGfx&&a.galGfx.removeSelf()},addPlanet:function(a,b){this.planets[a]=b;this.add(b)},addShip:function(a,b){this.ships[a]=
b;this.playerNum==a&&(this.player=b);this.add(b)},addTorp:function(a,b){this.torps[a]=b;this.add(b)},removeTorp:function(a){this.remove(this.torps[a]);this.torps[a]=void 0},centerView:function(a,b){this.viewX=a;this.viewY=b},netrek2world:function(a,b){return[(a-this.viewX)/this.subgalacticFactor+this.wCanvas.width/2,(b-this.viewY)/this.subgalacticFactor+this.wCanvas.height/2]},netrek2tac:function(a,b){return[a/this.galacticFactor,b/this.galacticFactor]},byte2rad:function(a){return 2*a/255*Math.PI},
rad2byte:function(a){0>a&&(a=2*Math.PI+a);return Math.floor(255*a/(2*Math.PI))},getAngleFromCenter:function(a,b){var c=a-this.wCanvas.width/2,h=this.wCanvas.height/2-b,j=Math.atan(c/h);0>h&&(j*=-1,j=0<c?Math.PI-j:-Math.PI-j);return j},Planet:function(a,b,c,h,j){var d=world.netrek2world(a,b),d=new Circle(18,{y:d[0],x:d[1],fill:"none",stroke:"#FF0"}),c=new TextNode(c,{y:d.radius+15,textAlign:"center",fill:"yellow",scale:1.2,font:"bold 9px courier"});d.append(c);-1!=h.indexOf(this.FUEL)&&(h=new Polygon([0,
0,5,0,8,2,8,13,0,13],{x:d.radius-12,y:-7}),h.append(new Polygon([2,3,5,6])),h.append(new Polygon([2,6,5,3])),d.append(h));this.x=a;this.y=b;this.gfx=d;a=world.netrek2tac(a,b);this.galGfx=new Circle(this.radius,{y:a[0],x:a[1],stroke:"#FF0",radius:5,zIndex:1});this.includingWorld=j}};world.Planet.prototype={FUEL:0,REPAIR:1};
